<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout – Self Service Ordering</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- STRIPE.JS -->
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200">
    <div class="max-w-6xl mx-auto flex justify-between items-center p-4">
      <div class="flex items-center gap-3">
        <h1 class="text-xl sm:text-2xl font-semibold">Self Service Ordering</h1>
      </div>
      <nav class="flex items-center gap-2 ml-auto">
        <a href="customer_main.html"
           class="bg-gray-100 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-200 transition">Home</a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-grow max-w-4xl mx-auto px-4 py-8">
    <!-- Order Summary -->
    <section id="orderSummary" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">Your Order</h2>
      <div id="orderItems" class="divide-y divide-gray-100">
        <p class="text-gray-500 text-center py-4">Loading your cart...</p>
      </div>
      <div class="flex justify-between items-center mt-4 text-lg font-semibold">
        <span>Total:</span>
        <span id="orderTotal">$0.00</span>
      </div>
    </section>

    <!-- Customer Info -->
    <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">Customer Information</h2>
      <form id="checkoutForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Full Name</label>
          <input type="text" id="custName" class="mt-1 w-full border rounded-md p-2" placeholder="John Doe" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Email Address</label>
          <input type="email" id="custEmail" class="mt-1 w-full border rounded-md p-2" placeholder="john@example.com" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Phone Number (optional)</label>
          <input type="tel" id="custPhone" class="mt-1 w-full border rounded-md p-2" placeholder="(555) 123-4567">
        </div>
      </form>
    </section>

    <!-- Payment Section -->
    <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-lg font-semibold mb-4">Payment</h2>
      <p class="text-sm text-gray-600 mb-4">
        Secure payment powered by <strong>Stripe</strong>. You will be redirected to complete payment.
      </p>
      <button id="placeOrderBtn"
        class="w-full bg-blue-600 text-white py-3 rounded-md text-lg font-medium hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
        disabled>
        <span id="btnText">Place Order</span>
        <span id="btnSpinner" class="hidden">Processing...</span>
      </button>
    </section>

    <p id="statusMsg" class="text-center text-sm mt-4 text-gray-600"></p>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 mt-10">
    <div class="max-w-6xl mx-auto p-4 text-center text-xs text-gray-500">
      © 2025 Self Service Ordering. All rights reserved.
    </div>
  </footer>

<!-- Customer Session Management -->
<script>
const CustomerSession = {
    isLoggedIn() {
        return localStorage.getItem('customerLoggedIn') === 'true';
    },
    getCustomer() {
        const data = localStorage.getItem('customerData');
        return data ? JSON.parse(data) : null;
    },
    setSession(customerData) {
        localStorage.setItem('customerLoggedIn', 'true');
        localStorage.setItem('customerData', JSON.stringify(customerData));
        localStorage.setItem('customerEmail', customerData.email);
    },
    clearSession() {
        localStorage.removeItem('customerLoggedIn');
        localStorage.removeItem('customerData');
        localStorage.removeItem('customerEmail');
        fetch('/api/logout', { method: 'POST' }).catch(() => {});
    },
    populateCheckoutForm() {
        if (this.isLoggedIn() && document.getElementById('custName')) {
            const customer = this.getCustomer();
            document.getElementById('custName').value = customer.name || '';
            document.getElementById('custEmail').value = customer.email || '';
            document.getElementById('custEmail').readOnly = true;
        }
    },
    updateNavigation() {
        const loginBtn = document.querySelector('a[href="customer_login.html"]');
        if (loginBtn) {
            if (this.isLoggedIn()) {
                loginBtn.textContent = 'Logout';
                loginBtn.href = '#';
                loginBtn.onclick = (e) => {
                    e.preventDefault();
                    this.clearSession();
                    window.location.href = 'customer_main.html';
                };
            } else {
                loginBtn.textContent = 'Login';
                loginBtn.href = 'customer_login.html';
                loginBtn.onclick = null;
            }
        }
    }
};
</script>

<!-- Cart & Stripe Checkout Logic -->
<script>
const STRIPE_PUBLISHABLE_KEY = 'pk_test_51SFy9hAEv5kiH6la3apUe0ronAHocibuAjVdd9r1W7zAFYJpi4F90BHK5VCdMqyxIIaqaifHltWO1ZAygdYTzwCp00S0q23MLJ';

const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

const Cart = {
  items: JSON.parse(localStorage.getItem('cartItems')) || [],
  getTotal() {
    return this.items.reduce((sum, i) => sum + i.priceCents * i.qty, 0) / 100;
  },
  clear() {
    this.items = [];
    localStorage.removeItem('cartItems');
  },
};

function renderOrder() {
  const container = document.getElementById('orderItems');
  const totalEl = document.getElementById('orderTotal');
  container.innerHTML = '';

  if (!Cart.items.length) {
    container.innerHTML = '<p class="text-gray-500 text-center py-4">Your cart is empty.</p>';
    totalEl.textContent = '$0.00';
    document.getElementById('placeOrderBtn').disabled = true;
    return;
  }

  Cart.items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'py-3 flex justify-between';
    div.innerHTML = `
      <span>${item.name} × ${item.qty}</span>
      <span>$${(item.priceCents * item.qty / 100).toFixed(2)}</span>
    `;
    container.appendChild(div);
  });

  totalEl.textContent = '$' + Cart.getTotal().toFixed(2);
  document.getElementById('placeOrderBtn').disabled = false;
}

function showStatus(msg, isError = false) {
  const el = document.getElementById('statusMsg');
  el.textContent = msg;
  el.className = `text-center text-sm mt-4 ${isError ? 'text-red-600' : 'text-green-600'}`;
}

function setButtonLoading(loading) {
  const btn = document.getElementById('placeOrderBtn');
  const text = document.getElementById('btnText');
  const spinner = document.getElementById('btnSpinner');
  btn.disabled = loading;
  text.classList.toggle('hidden', loading);
  spinner.classList.toggle('hidden', !loading);
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  CustomerSession.updateNavigation();
  CustomerSession.populateCheckoutForm();
  renderOrder();
});

// Place Order → Stripe Checkout
document.getElementById('placeOrderBtn').addEventListener('click', async () => {
  const name = document.getElementById('custName').value.trim();
  const email = document.getElementById('custEmail').value.trim();
  const phone = document.getElementById('custPhone').value.trim();

  if (!name || !email || !Cart.items.length) {
    showStatus('Please fill all required fields and ensure cart is not empty.', true);
    return;
  }

  setButtonLoading(true);
  showStatus('Creating secure checkout session...');

  const customerData = CustomerSession.isLoggedIn() ? CustomerSession.getCustomer() : null;

  const payload = {
    customer: { name, email, phone },
    items: Cart.items.map(i => ({ item_id: i.id, quantity: i.qty }))
  };

  try {
    const res = await fetch('/api/checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!data.success || !data.sessionId) {
      throw new Error(data.message || 'Failed to create checkout session');
    }

    // Redirect to Stripe Checkout
    const { error } = await stripe.redirectToCheckout({ sessionId: data.sessionId });

    if (error) {
      throw error;
    }

  } catch (err) {
    console.error('Checkout error:', err);
    showStatus(err.message || 'Payment failed. Please try again.', true);
    setButtonLoading(false);
  }
});

// Optional: Handle return from Stripe
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('session_id')) {
  showStatus('Payment successful! Your order is being processed.', false);
  Cart.clear();
  renderOrder();
  setTimeout(() => {
    window.location.href = 'customer_main.html';
  }, 3000);
} else if (urlParams.get('canceled')) {
  showStatus('Payment canceled. You can try again.', true);
}
</script>

</body>
</html>
